openapi: 3.1.0
info:
  title: VideoAnnotator Error Envelope Schema
  version: 1.3.0
  description: |
    Standard error response format used across all VideoAnnotator API endpoints.
    All 4xx and 5xx responses use this envelope for consistency.

components:
  schemas:
    ErrorEnvelope:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/ErrorDetail'
      description: Top-level wrapper for all error responses

    ErrorDetail:
      type: object
      required:
        - code
        - message
        - timestamp
      properties:
        code:
          type: string
          description: |
            Machine-readable error code (uppercase snake_case).
            Used by clients for error handling logic.
          examples:
            - "JOB_NOT_FOUND"
            - "PIPELINE_NOT_FOUND"
            - "INVALID_CONFIG"
            - "JOB_ALREADY_COMPLETED"
            - "STORAGE_FULL"
            - "GPU_OUT_OF_MEMORY"
            - "UNAUTHORIZED"
            - "FORBIDDEN"
            - "INTERNAL_SERVER_ERROR"
        message:
          type: string
          description: |
            Human-readable error message.
            Localized to server language (English by default).
          examples:
            - "Job abc123 not found"
            - "Configuration validation failed"
            - "Insufficient disk space"
        detail:
          type: object
          nullable: true
          description: |
            Additional structured error context (optional).
            Contents vary by error type (e.g., validation errors, system info).
          additionalProperties: true
          examples:
            - errors:
                - field: "pipeline"
                  message: "Pipeline 'xyz' not found"
            - pid: 12345
              signal: "SIGKILL"
        hint:
          type: string
          nullable: true
          description: |
            Suggested action to fix the error.
            Actionable guidance for developers/users.
          examples:
            - "Use GET /api/v1/jobs to list all jobs"
            - "Available pipelines: face, person, audio, scene"
            - "Reduce batch_size or wait for running jobs to finish"
        field:
          type: string
          nullable: true
          description: |
            Field name for validation errors (dot-notation path).
            Null for non-validation errors.
          examples:
            - "pipeline"
            - "config.detection.confidence_threshold"
        timestamp:
          type: string
          format: date-time
          description: |
            When error occurred (ISO 8601 UTC).
            Used for error tracking and debugging.
          example: "2025-10-11T10:30:45.123Z"

# Error code registry (for documentation)
# These codes should be used consistently across all endpoints

x-error-codes:
  JOB_NOT_FOUND:
    http_status: 404
    description: Job ID doesn't exist in database
    hint_template: "Check job ID or use GET /api/v1/jobs to list jobs"
    example_message: "Job {job_id} not found"

  PIPELINE_NOT_FOUND:
    http_status: 404
    description: Pipeline name not found in registry
    hint_template: "Available pipelines: {pipeline_list}"
    example_message: "Pipeline '{pipeline_name}' not found in registry"

  INVALID_CONFIG:
    http_status: 400
    description: Configuration validation failed
    hint_template: "Fix validation errors: {error_summary}"
    example_message: "Configuration validation failed"
    detail_structure:
      errors:
        - field: "config.field_name"
          message: "Error description"
          code: "SUB_ERROR_CODE"

  JOB_ALREADY_COMPLETED:
    http_status: 409
    description: Cannot cancel job in terminal state
    hint_template: "Job already in terminal state: {status}"
    example_message: "Cannot cancel job in {status} state"

  STORAGE_FULL:
    http_status: 507
    description: Insufficient disk space for operation
    hint_template: "Free up {required_gb}GB or configure larger storage"
    example_message: "Insufficient disk space (need {required_gb}GB, have {available_gb}GB)"

  GPU_OUT_OF_MEMORY:
    http_status: 507
    description: GPU VRAM exhausted
    hint_template: "Reduce batch_size or wait for running jobs to finish"
    example_message: "GPU out of memory (requested {requested_mb}MB, available {available_mb}MB)"

  UNAUTHORIZED:
    http_status: 401
    description: Missing or invalid authentication credentials
    hint_template: "Provide valid API key or JWT token"
    example_message: "Missing or invalid API key"

  FORBIDDEN:
    http_status: 403
    description: Insufficient permissions for resource
    hint_template: "Contact admin for access to this resource"
    example_message: "Insufficient permissions to access {resource}"

  CANCELLATION_FAILED:
    http_status: 500
    description: Failed to terminate worker process
    hint_template: "Worker process may require manual cleanup. Contact support."
    example_message: "Failed to terminate worker process (PID {pid})"

  VALIDATION_ERROR:
    http_status: 500
    description: Internal validation system error
    hint_template: "Check registry metadata integrity. Contact support."
    example_message: "Failed to load validation schema for pipeline '{pipeline}'"

  INTERNAL_SERVER_ERROR:
    http_status: 500
    description: Unexpected server error
    hint_template: "Contact support with timestamp: {timestamp}"
    example_message: "An unexpected error occurred"

# Example responses using ErrorEnvelope

paths:
  /example/error-responses:
    get:
      responses:
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_config:
                  summary: Configuration validation error
                  value:
                    error:
                      code: "INVALID_CONFIG"
                      message: "Configuration validation failed"
                      detail:
                        errors:
                          - field: "config.detection.confidence_threshold"
                            message: "Value must be between 0.0 and 1.0"
                            code: "VALUE_OUT_OF_RANGE"
                      hint: "Fix validation errors in config.detection section"
                      timestamp: "2025-10-11T10:30:45.123Z"

        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                job_not_found:
                  summary: Job doesn't exist
                  value:
                    error:
                      code: "JOB_NOT_FOUND"
                      message: "Job 550e8400-e29b-41d4-a716-446655440000 not found"
                      hint: "Check job ID or use GET /api/v1/jobs to list all jobs"
                      timestamp: "2025-10-11T10:30:45.123Z"
                pipeline_not_found:
                  summary: Pipeline not in registry
                  value:
                    error:
                      code: "PIPELINE_NOT_FOUND"
                      message: "Pipeline 'invalid_name' not found in registry"
                      hint: "Available pipelines: face, person, audio, scene"
                      timestamp: "2025-10-11T10:30:45.123Z"

        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              example:
                error:
                  code: "JOB_ALREADY_COMPLETED"
                  message: "Cannot cancel job in COMPLETED state"
                  hint: "Job already in terminal state: COMPLETED"
                  timestamp: "2025-10-11T10:30:45.123Z"

        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              example:
                error:
                  code: "INTERNAL_SERVER_ERROR"
                  message: "An unexpected error occurred"
                  detail:
                    exception_type: "AttributeError"
                    trace_id: "abc123def456"
                  hint: "Contact support with timestamp: 2025-10-11T10:30:45.123Z"
                  timestamp: "2025-10-11T10:30:45.123Z"

        '507':
          description: Insufficient Storage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                disk_full:
                  summary: Disk space exhausted
                  value:
                    error:
                      code: "STORAGE_FULL"
                      message: "Insufficient disk space (need 10.5GB, have 2.1GB)"
                      detail:
                        required_gb: 10.5
                        available_gb: 2.1
                      hint: "Free up 8.4GB or configure larger storage volume"
                      timestamp: "2025-10-11T10:30:45.123Z"
                gpu_oom:
                  summary: GPU memory exhausted
                  value:
                    error:
                      code: "GPU_OUT_OF_MEMORY"
                      message: "GPU out of memory (requested 8192MB, available 512MB)"
                      detail:
                        requested_mb: 8192
                        available_mb: 512
                        device: "NVIDIA GeForce RTX 3080"
                      hint: "Reduce batch_size from 64 to 16 or wait for running jobs to finish"
                      timestamp: "2025-10-11T10:30:45.123Z"
