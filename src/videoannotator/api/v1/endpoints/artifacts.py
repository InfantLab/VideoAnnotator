"""API endpoints for accessing job artifacts.

This module provides endpoints for listing and downloading artifacts
generated by pipelines.
"""

from fastapi import APIRouter, Depends, HTTPException
from fastapi.responses import StreamingResponse

from videoannotator.api.dependencies import get_current_user
from videoannotator.services.artifacts import get_annotation_artifacts
from videoannotator.utils.compression import create_job_zip_archive
from videoannotator.utils.logging_config import get_logger

logger = get_logger("api.artifacts")

router = APIRouter()


@router.get("/{job_id}/artifacts")
async def download_job_artifacts(
    job_id: str,
    current_user=Depends(get_current_user),
):
    """Download all artifacts for a specific job as a ZIP archive.

    Args:
        job_id: The unique identifier of the job.
        current_user: The authenticated user.

    Returns:
        StreamingResponse: A ZIP file containing the artifacts.
    """
    try:
        # Get list of artifacts to download
        artifacts = get_annotation_artifacts(job_id)

        if not artifacts:
            raise HTTPException(
                status_code=404, detail=f"No artifacts found for job {job_id}"
            )

        # Create generator for ZIP file
        zip_generator = create_job_zip_archive(job_id, artifacts)

        # Return streaming response
        return StreamingResponse(
            zip_generator,
            media_type="application/zip",
            headers={
                "Content-Disposition": f"attachment; filename=job_{job_id}_artifacts.zip"
            },
        )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error downloading artifacts for job {job_id}: {e}")
        raise HTTPException(
            status_code=500, detail="Internal server error while preparing download"
        ) from e
